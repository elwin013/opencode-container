#!/usr/bin/env bash

set -euo pipefail

CONTAINER_IMAGE="${CONTAINER_IMAGE:-opencode-container}"
CONTAINER_NAME="opencode-$(basename "$(pwd)")"

DOCKER_RUN_ARGS=()
OPENCODE_ARGS=("$@")

if [[ "$#" -gt 0 ]]; then
  OPENCODE_ARGS=()
  parsing_docker_args=true

  for arg in "$@"; do
    if [[ "$arg" == "--" && "$parsing_docker_args" == true ]]; then
      parsing_docker_args=false
      continue
    fi

    if [[ "$parsing_docker_args" == true ]]; then
      DOCKER_RUN_ARGS+=("$arg")
    else
      OPENCODE_ARGS+=("$arg")
    fi
  done

  if [[ "$parsing_docker_args" == true ]]; then
    OPENCODE_ARGS=("$@")
    DOCKER_RUN_ARGS=()
  fi
fi

mkdir -p "$HOME/.local/state/opencode" "$HOME/.local/share/opencode" "$HOME/.config/opencode"

exec docker run --rm --tty --interactive \
  --name "$CONTAINER_NAME" \
  --add-host=host.docker.internal:host-gateway \
  -v "$HOME/.local/state/opencode:/root/.local/state/opencode:Z" \
  -v "$HOME/.local/share/opencode:/root/.local/share/opencode:Z" \
  -v "$HOME/.config/opencode:/root/.config/opencode:Z" \
  -v "$(pwd):/app:Z" \
  "${DOCKER_RUN_ARGS[@]}" \
  "$CONTAINER_IMAGE" \
  opencode "${OPENCODE_ARGS[@]}"
